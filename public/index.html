<html>
  <head>
    <title>BulkRef</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>

    <script type="text/javascript">
      var i = -1;
      var titles;
      
      $(function() {
      $('#btn').click(function(e) {
      console.log('clicked');

      $("#citation").text("");
      $("#doi").text("");

      
      var titleData;
      if (i < 0) {
      var multiline = $('#title-area').val();
      titles = multiline.split('\n');

      //var title = $('#title-text').val();
      //var titleData = JSON.stringify([title]);
	      i = 0;
	      }
	      else if (i >= titles.length-1) {
	alert('done');
	return;
	}
	var title = titles[i];
	i++;

	if (!title) {
	alert('empty title');
	return;
	}
	
	titleData = JSON.stringify([title]);	      

	$('#btn').text('Thinking...');
	$('#btn').prop('disabled', true);
	
      $.ajax({
      url:'/links',
      type:"POST",
      data:titleData,
      contentType:"application/json; charset=utf-8",
      dataType:"json",
      success: function(data) {
      console.log("data from ajax:");
	console.log(data);

	if (data.results[0].match) {

      var citation = data.results[0].citation;
      console.log(data.results[0].citation);
      $("#citation").text(citation);

      var doi = data.results[0].doi;
      console.log(doi);
	$("#doi").text(doi);

	var current = $("#doi-area").val();
	if (current.length > 0)
	{
	current += "\n";
	}
	$("#doi-area").val(current + doi);

	$('#btn').text('Click me!');
	$('#btn').prop('disabled', false);

	}
	else {
	alert("Didn't find match for '" + title + "'");
	$('#btn').text('Click me!');
	$('#btn').prop('disabled', false);
	}
	
	},
	error: function(jqxhr, textStatus, errorThrown) {
	console.log("textStatus:");
	console.log(textStatus);
	console.log("errorThrown:");
	console.log(errorThrown);
	alert("Unable to find DOI for '" + title + "'");
	$('#btn').text('Click me!');
	$('#btn').prop('disabled', false);
	}
      });
      
      });
      });
    </script>
  </head>
  <body>
    <p>Titles to search for:</p>
    <!--
    <input type="text" id="title-text" style="width:300px"></input>
    <br>

A Bayesian approach to star-galaxy classification
new insight into the strategy for nitrogen metabolism in plant cells
Beta vulgaris: a dearth of antidepressant activity in mice
    -->
    <textarea id="title-area" cols="40" rows="5" wrap="off"></textarea>

    <button id="btn" type="button" class="btn btn-primary">Click me!</button>
    
    <div>Current Citation:</div>
    <div id="citation"></div>
    <div>Current DOI:</div>
    <div id="doi"></div>
    <div>All DOIs:</div>
    <textarea id="doi-area" cols="40" rows="5" readonly></textarea>
  </body>
</html>
